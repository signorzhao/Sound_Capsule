# JIT (Just-In-Time) å†³ç­–æµå®ç°æŠ¥å‘Š

## ğŸ“… å®æ–½æ—¥æœŸ
2026-01-12

## âœ… å®æ–½å®ŒæˆçŠ¶æ€

### Phase 1: ç¯å¢ƒä¿®å¤ä¸åç«¯å¯åŠ¨ âœ…
- [x] ä¿®å¤ `.env.supabase` æ–‡ä»¶æƒé™é—®é¢˜
- [x] åç«¯ API æœåŠ¡å™¨æˆåŠŸå¯åŠ¨ (`http://localhost:5002`)
- [x] å¥åº·æ£€æŸ¥é€šè¿‡

### Phase 2: Rust/Tauri é›†æˆ âœ…
- [x] ä¿®å¤æ‰€æœ‰ Rust ç¼–è¯‘é”™è¯¯
- [x] å®ç° `open_rpp_in_reaper` Tauri å‘½ä»¤
- [x] æ”¯æŒ macOSã€Windowsã€Linux ä¸‰å¹³å°
- [x] Rust ä»£ç ç¼–è¯‘é€šè¿‡ï¼ˆä»…æœ‰æœªä½¿ç”¨ä»£ç è­¦å‘Šï¼‰

### Phase 3: å‰ç«¯ JIT ç»„ä»¶å¼€å‘ âœ…
- [x] åˆ›å»º `SmartActionButton.jsx` ç»„ä»¶
- [x] åˆ›å»º `DownloadConfirmModal.jsx` ç»„ä»¶
- [x] é‡æ„ `CapsuleLibrary.jsx` é›†æˆæ–°ç»„ä»¶
- [x] å®ç°æ™ºèƒ½çŠ¶æ€æœºé€»è¾‘
- [x] æ—  lint é”™è¯¯

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½å®ç°

### 1. SmartActionButton ç»„ä»¶
**æ–‡ä»¶**: `webapp/src/components/SmartActionButton.jsx`

**åŠŸèƒ½**: æ ¹æ®èƒ¶å›Šçš„èµ„æºçŠ¶æ€åŠ¨æ€æ˜¾ç¤ºä¸åŒçš„æŒ‰é’®æ ·å¼å’Œè¡Œä¸ºã€‚

**æ”¯æŒçš„çŠ¶æ€**:
| çŠ¶æ€ | å›¾æ ‡ | æ–‡æœ¬ | æ ·å¼ | è¡Œä¸º |
|------|------|------|------|------|
| `cloud_only` | â˜ï¸ Cloud | "è·å–" | è“è‰² | è§¦å‘ä¸‹è½½å†³ç­–å¼¹çª— |
| `downloading` | ğŸ”„ Loader | "ä¸‹è½½ä¸­..." | é»„è‰² + æ—‹è½¬åŠ¨ç”» | æ˜¾ç¤ºæç¤ºä¿¡æ¯ |
| `synced` | â–¶ï¸ Play | "æ‰“å¼€" | ç»¿è‰² | ç›´æ¥åœ¨ REAPER ä¸­æ‰“å¼€ |
| `partial` | âš ï¸ AlertTriangle | "ä¿®å¤" | æ©™è‰² | è§¦å‘ä¸‹è½½å†³ç­–å¼¹çª— |

**ç‰¹æ€§**:
- é˜²æ­¢å†’æ³¡ (`e.stopPropagation()`)
- æ”¯æŒè‡ªå®šä¹‰ `className`
- æä¾› tooltip æç¤º

---

### 2. DownloadConfirmModal ç»„ä»¶
**æ–‡ä»¶**: `webapp/src/components/DownloadConfirmModal.jsx`

**åŠŸèƒ½**: JIT å†³ç­–å¼¹çª—ï¼Œè®©ç”¨æˆ·åœ¨éœ€è¦æ—¶é€‰æ‹©ä¸‹è½½ç­–ç•¥ã€‚

**UI è®¾è®¡**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  èµ„æºæœªå°±ç»ª                      âœ•       â”‚
â”‚                                           â”‚
â”‚  èƒ¶å›Š [name] çš„éŸ³é¢‘æ–‡ä»¶å°šæœªä¸‹è½½åˆ°æœ¬åœ°ã€‚  â”‚
â”‚  æ‚¨å¸Œæœ›å¦‚ä½•å¤„ç†ï¼Ÿ                         â”‚
â”‚                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ“¥ ä¸‹è½½å®Œæ•´èµ„æºå¹¶æ‰“å¼€ (æ¨è)      â”‚   â”‚  <- ä¸»è¦æ“ä½œ
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ“„ ä»…æ‰“å¼€å·¥ç¨‹æ–‡ä»¶ (åª’ä½“ç¦»çº¿)      â”‚   â”‚  <- é™çº§æ“ä½œ
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**äº¤äº’**:
- ç‚¹å‡»"ä¸‹è½½å®Œæ•´èµ„æºå¹¶æ‰“å¼€"ï¼šå¯åŠ¨åå°ä¸‹è½½ï¼Œæ˜¾ç¤ºè¿›åº¦æ¡
- ç‚¹å‡»"ä»…æ‰“å¼€å·¥ç¨‹æ–‡ä»¶"ï¼šè·³è¿‡ä¸‹è½½ï¼Œç›´æ¥åœ¨ REAPER ä¸­æ‰“å¼€ RPPï¼ˆWAV å°†æ˜¾ç¤ºä¸ºç¦»çº¿ï¼‰
- ç‚¹å‡»å³ä¸Šè§’ X æˆ–èƒŒæ™¯ï¼šå–æ¶ˆæ“ä½œ

---

### 3. CapsuleLibrary æ™ºèƒ½ç‚¹å‡»é€»è¾‘
**æ–‡ä»¶**: `webapp/src/components/CapsuleLibrary.jsx`

**æ ¸å¿ƒå‡½æ•°**: `handleSmartClick(capsule)`

**å†³ç­–æµç¨‹å›¾**:
```
ç”¨æˆ·ç‚¹å‡»æŒ‰é’®
      â”‚
      â”œâ”€ [status === 'synced'] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> ç›´æ¥æ‰“å¼€ REAPER
      â”‚                                      (è°ƒç”¨ Tauri Command)
      â”‚
      â”œâ”€ [status === 'downloading'] â”€â”€â”€â”€â”€â”€â”€> æç¤º"æ­£åœ¨ä¸‹è½½ä¸­..."
      â”‚                                      (Toast æ¶ˆæ¯)
      â”‚
      â””â”€ [status === 'cloud_only' æˆ– 'partial']
                â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> æ˜¾ç¤º DownloadConfirmModal
                                      â”‚
                                      â”œâ”€ ç”¨æˆ·é€‰æ‹©"ä¸‹è½½å¹¶æ‰“å¼€"
                                      â”‚  â””> POST /api/capsules/:id/download-assets
                                      â”‚     â””> æ˜¾ç¤º DownloadProgressDialog
                                      â”‚        â””> å®Œæˆåè‡ªåŠ¨æ‰“å¼€ REAPER
                                      â”‚
                                      â””â”€ ç”¨æˆ·é€‰æ‹©"ä»…æ‰“å¼€ RPP"
                                         â””> è°ƒç”¨ Tauri Command (ç¦»çº¿æ¨¡å¼)
```

**å…³é”®å®ç°**:
```javascript
const handleSmartClick = async (capsule) => {
  const status = capsule.asset_status || capsule.cloud_status || 'cloud_only';

  if (status === 'synced') {
    await openInReaper(capsule);
    return;
  }

  if (status === 'downloading') {
    toast.info("èµ„æºæ­£åœ¨ä¸‹è½½ä¸­ï¼Œè¯·ç¨å€™...");
    return;
  }

  setModalCapsule(capsule); // è§¦å‘å¼¹çª—
};
```

---

### 4. Tauri Native é›†æˆ
**æ–‡ä»¶**: `webapp/src-tauri/src/sidecar.rs`

**Tauri å‘½ä»¤**: `open_rpp_in_reaper`

**è·¨å¹³å°æ”¯æŒ**:
- **macOS**: `open <path>`
- **Windows**: `cmd /C start "" <path>`
- **Linux**: `xdg-open <path>`

**Rust å®ç°**:
```rust
#[tauri::command]
pub fn open_rpp_in_reaper(path: String) -> Result<(), String> {
    println!("ğŸ“„ æ­£åœ¨æ‰“å¼€ RPP æ–‡ä»¶: {}", path);

    #[cfg(target_os = "macos")]
    let result = Command::new("open").arg(&path).spawn();

    #[cfg(target_os = "windows")]
    let result = Command::new("cmd")
        .args(["/C", "start", "", &path])
        .spawn();

    #[cfg(target_os = "linux")]
    let result = Command::new("xdg-open").arg(&path).spawn();

    match result {
        Ok(_) => Ok(()),
        Err(e) => Err(format!("æ— æ³•æ‰“å¼€æ–‡ä»¶: {}", e)),
    }
}
```

**å‰ç«¯è°ƒç”¨**:
```javascript
import { invoke } from '@tauri-apps/api/core';

await invoke('open_rpp_in_reaper', { path: rppPath });
```

---

### 5. åç«¯ API é›†æˆ
**æ–‡ä»¶**: `data-pipeline/capsule_download_api.py`

**æ–°å¢è·¯ç”±**:
```
POST   /api/capsules/:id/download-assets   # å¼€å§‹ä¸‹è½½å®Œæ•´èµ„æº
GET    /api/downloads/status/:id            # æŸ¥è¯¢ä¸‹è½½çŠ¶æ€
POST   /api/downloads/:task_id/pause        # æš‚åœä¸‹è½½
POST   /api/downloads/:task_id/resume       # æ¢å¤ä¸‹è½½
GET    /api/downloads/queue                 # æŸ¥è¯¢ä¸‹è½½é˜Ÿåˆ—
```

**é›†æˆç‚¹**: `data-pipeline/capsule_api.py`
```python
from capsule_download_api import register_download_routes

register_download_routes(app)
```

---

## ğŸ“Š æµ‹è¯•åœºæ™¯

### âœ… åœºæ™¯ 1: äº‘ç«¯èƒ¶å›Šï¼ˆæœªä¸‹è½½ï¼‰
1. ç”¨æˆ·æ‰“å¼€èƒ¶å›Šåº“
2. çœ‹åˆ°æŸä¸ªèƒ¶å›ŠæŒ‰é’®æ˜¾ç¤º"â˜ï¸ è·å–"ï¼ˆè“è‰²ï¼‰
3. ç‚¹å‡»æŒ‰é’®
4. å¼¹å‡º `DownloadConfirmModal`
5. ç”¨æˆ·é€‰æ‹©"ä¸‹è½½å®Œæ•´èµ„æºå¹¶æ‰“å¼€"
6. æ˜¾ç¤º `DownloadProgressDialog`ï¼Œå±•ç¤ºè¿›åº¦æ¡
7. ä¸‹è½½å®Œæˆåï¼Œè‡ªåŠ¨åœ¨ REAPER ä¸­æ‰“å¼€

### âœ… åœºæ™¯ 2: å·²åŒæ­¥èƒ¶å›Š
1. ç”¨æˆ·çœ‹åˆ°æŒ‰é’®æ˜¾ç¤º"â–¶ï¸ æ‰“å¼€"ï¼ˆç»¿è‰²ï¼‰
2. ç‚¹å‡»æŒ‰é’®
3. **ç›´æ¥**è°ƒç”¨ Tauri å‘½ä»¤ï¼Œåœ¨ REAPER ä¸­æ‰“å¼€ï¼ˆæ— å¼¹çª—ï¼‰

### âœ… åœºæ™¯ 3: æ­£åœ¨ä¸‹è½½ä¸­çš„èƒ¶å›Š
1. ç”¨æˆ·çœ‹åˆ°æŒ‰é’®æ˜¾ç¤º"ğŸ”„ ä¸‹è½½ä¸­..."ï¼ˆé»„è‰²ï¼Œæ—‹è½¬åŠ¨ç”»ï¼‰
2. ç‚¹å‡»æŒ‰é’®
3. æ˜¾ç¤º Toast æç¤º"èµ„æºæ­£åœ¨ä¸‹è½½ä¸­ï¼Œè¯·ç¨å€™..."

### âœ… åœºæ™¯ 4: ç¦»çº¿æ¨¡å¼æ‰“å¼€
1. ç”¨æˆ·ç‚¹å‡»"â˜ï¸ è·å–"æŒ‰é’®
2. å¼¹å‡º `DownloadConfirmModal`
3. ç”¨æˆ·é€‰æ‹©"ä»…æ‰“å¼€å·¥ç¨‹æ–‡ä»¶"
4. è·³è¿‡ä¸‹è½½ï¼Œç›´æ¥è°ƒç”¨ Tauri å‘½ä»¤
5. REAPER æ‰“å¼€å·¥ç¨‹ï¼Œä½† WAV æ–‡ä»¶æ˜¾ç¤ºä¸ºç¦»çº¿/ç¼ºå¤±

---

## ğŸ”§ æŠ€æœ¯æ ˆ

### å‰ç«¯
- **æ¡†æ¶**: React 18
- **UI**: Tailwind CSS
- **å›¾æ ‡**: Lucide React
- **è·¨å¹³å°**: Tauri 2.x
- **API è°ƒç”¨**: Fetch API + Tauri `invoke`

### åç«¯
- **æ¡†æ¶**: Flask (Python)
- **æ•°æ®åº“**: SQLite
- **äº‘å­˜å‚¨**: Supabase Storage
- **ä¸‹è½½ç®¡ç†**: `DownloadQueue` + `ResumableDownloader`

### æ¡Œé¢ç«¯
- **æ¡†æ¶**: Tauri 2.x
- **è¯­è¨€**: Rust
- **ç³»ç»Ÿè°ƒç”¨**: `std::process::Command`

---

## ğŸ“¦ æ–‡ä»¶å˜æ›´æ¸…å•

### æ–°å¢æ–‡ä»¶
1. `webapp/src/components/SmartActionButton.jsx`
2. `webapp/src/components/DownloadConfirmModal.jsx`
3. `data-pipeline/capsule_download_api.py`
4. `data-pipeline/database/add_download_tracking.sql`

### ä¿®æ”¹æ–‡ä»¶
1. `webapp/src/components/CapsuleLibrary.jsx`
   - æ·»åŠ  JIT é€»è¾‘
   - é›†æˆæ–°ç»„ä»¶
   - é‡æ„ `handleImportToReaper`

2. `webapp/src-tauri/src/main.rs`
   - æ³¨å†Œ `open_rpp_in_reaper` å‘½ä»¤
   - ç§»é™¤æœªå®šä¹‰çš„ `check_sidecar`

3. `webapp/src-tauri/src/sidecar.rs`
   - å®ç° `open_rpp_in_reaper` å‘½ä»¤
   - ä¿®å¤ç”Ÿå‘½å‘¨æœŸå’Œæ‰€æœ‰æƒé—®é¢˜
   - ä¿®å¤ `stop_sidecar` å‡½æ•°

4. `data-pipeline/capsule_api.py`
   - å¯¼å…¥å¹¶æ³¨å†Œä¸‹è½½ API è·¯ç”±

---

## ğŸš€ è¿è¡ŒçŠ¶æ€

### æœåŠ¡çŠ¶æ€
- âœ… åç«¯ API: `http://localhost:5002` (è¿è¡Œä¸­)
- âœ… Vite Dev Server: `http://localhost:3000` (è¿è¡Œä¸­)
- âœ… Tauri App: ç¼–è¯‘æˆåŠŸï¼Œåº”ç”¨è¿è¡Œä¸­

### ç¼–è¯‘çŠ¶æ€
- âœ… Rust: ç¼–è¯‘é€šè¿‡ï¼ˆ7 ä¸ªæœªä½¿ç”¨ä»£ç è­¦å‘Šï¼Œä¸å½±å“åŠŸèƒ½ï¼‰
- âœ… JavaScript/React: æ—  lint é”™è¯¯
- âœ… Python: åç«¯æœåŠ¡ç¨³å®šè¿è¡Œ

---

## ğŸ‰ å®æ–½æ€»ç»“

### æˆåŠŸè¦ç‚¹
1. **ä¾èµ–ä¼˜å…ˆç­–ç•¥**: å…ˆåç«¯ â†’ Tauri â†’ å‰ç«¯çš„é¡ºåºé¿å…äº†å¤§é‡è°ƒè¯•æ—¶é—´
2. **æ¨¡å—åŒ–è®¾è®¡**: ç»„ä»¶èŒè´£æ¸…æ™°ï¼Œ`SmartActionButton` åªè´Ÿè´£ UIï¼Œé€»è¾‘åœ¨çˆ¶ç»„ä»¶
3. **å‘åå…¼å®¹**: `handleImportToReaper` è¢«é‡å®šå‘åˆ° `handleSmartClick`ï¼Œä¸ç ´åç°æœ‰ä»£ç 
4. **è·¨å¹³å°æ”¯æŒ**: Rust æ¡ä»¶ç¼–è¯‘ç¡®ä¿ä¸‰å¤§å¹³å°éƒ½èƒ½æ­£å¸¸æ‰“å¼€æ–‡ä»¶

### ç”¨æˆ·ä½“éªŒæå‡
- **æ™ºèƒ½åˆ¤æ–­**: ç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«èƒ¶å›ŠçŠ¶æ€ï¼Œæ— éœ€ç”¨æˆ·æ‰‹åŠ¨åˆ¤æ–­
- **æ¸…æ™°åé¦ˆ**: æ¯ä¸ªçŠ¶æ€éƒ½æœ‰å¯¹åº”çš„å›¾æ ‡ã€é¢œè‰²å’Œæ–‡æœ¬
- **çµæ´»é€‰æ‹©**: ç”¨æˆ·å¯ä»¥é€‰æ‹©å®Œæ•´ä¸‹è½½æˆ–ç¦»çº¿æ¨¡å¼
- **éé˜»å¡æ“ä½œ**: ä¸‹è½½åœ¨åå°è¿›è¡Œï¼Œä¸å½±å“å…¶ä»–æ“ä½œ

### æ€§èƒ½ä¼˜åŒ–
- **æŒ‰éœ€ä¸‹è½½**: åªåœ¨ç”¨æˆ·çœŸæ­£éœ€è¦æ—¶æ‰ä¸‹è½½å®Œæ•´èµ„æº
- **æ¸è¿›å¼åŠ è½½**: å…ƒæ•°æ®å’Œ RPP å…ˆè¡ŒåŒæ­¥ï¼ŒWAV æŒ‰éœ€è·å–
- **é˜Ÿåˆ—ç®¡ç†**: ä¸‹è½½ä»»åŠ¡æ’é˜Ÿï¼Œé¿å…åŒæ—¶ä¸‹è½½è¿‡å¤šèƒ¶å›Š

---

## ğŸ“ åç»­å»ºè®®

### çŸ­æœŸä¼˜åŒ–
1. æ·»åŠ ä¸‹è½½é˜Ÿåˆ—å¯è§†åŒ–é¢æ¿
2. æ”¯æŒæ‰¹é‡ä¸‹è½½å¤šä¸ªèƒ¶å›Š
3. æ·»åŠ ä¸‹è½½é€Ÿåº¦é™åˆ¶è®¾ç½®

### ä¸­æœŸæ”¹è¿›
1. å®ç°æ–­ç‚¹ç»­ä¼ ï¼ˆå·²æœ‰ `ResumableDownloader` åŸºç¡€ï¼‰
2. æ·»åŠ æ™ºèƒ½é¢„æµ‹ä¸‹è½½ï¼ˆåŸºäºç”¨æˆ·æ’­æ”¾å†å²ï¼‰
3. æ”¯æŒ P2P åˆ†äº«ï¼ˆå±€åŸŸç½‘å†…èƒ¶å›Šå…±äº«ï¼‰

### é•¿æœŸè§„åˆ’
1. ç¦»çº¿æ¨¡å¼å¢å¼ºï¼ˆæœ¬åœ°ç¼“å­˜ç­–ç•¥ï¼‰
2. äº‘ç«¯éŸ³é¢‘é¢„è§ˆï¼ˆæ— éœ€ä¸‹è½½å®Œæ•´æ–‡ä»¶ï¼‰
3. åˆ†å±‚å­˜å‚¨ç­–ç•¥ï¼ˆçƒ­æ•°æ®æœ¬åœ°ï¼Œå†·æ•°æ®äº‘ç«¯ï¼‰

---

## ğŸ‘¥ è´¡çŒ®è€…
- **åç«¯å¼€å‘**: å®Œæˆ API é›†æˆå’Œä¸‹è½½ç®¡ç†å™¨
- **å‰ç«¯å¼€å‘**: å®ç° JIT UI ç»„ä»¶å’ŒçŠ¶æ€ç®¡ç†
- **Rust å¼€å‘**: è·¨å¹³å° Tauri å‘½ä»¤å®ç°
- **æµ‹è¯•**: ç«¯åˆ°ç«¯åœºæ™¯éªŒè¯

---

## ğŸ“„ ç›¸å…³æ–‡æ¡£
- [JIT åˆ†æå’Œä¼˜åŒ–å»ºè®®](./jitåˆ†æå’Œä¼˜åŒ–å»ºè®®.md)
- [Phase B å®ŒæˆæŠ¥å‘Š](./PHASE_B5_COMPLETION_REPORT.md)
- [æ•°æ®åº“è¿ç§»è„šæœ¬](./data-pipeline/database/add_download_tracking.sql)

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026-01-12 16:50 CST  
**ç‰ˆæœ¬**: 1.0.0  
**çŠ¶æ€**: âœ… å®æ–½å®Œæˆï¼Œæµ‹è¯•é€šè¿‡
