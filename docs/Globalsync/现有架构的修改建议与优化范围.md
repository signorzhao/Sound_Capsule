### 🔴 优先级 1: 架构与稳定性 (必须修正)

#### 1. 数据库连接管理 (SQLite Concurrency)

- **现状**: 我们在 `capsule_db.py` 中虽然修复了事务问题，但在多线程环境（Flask API 线程 + 下载队列线程 + 自动扫描线程）下，SQLite 很容易报 `Database is locked` 错误。
    
- **修改建议**:
    
    - 引入 **连接池 (Connection Pooling)** 或者使用 `SQLAlchemy` 替代手写的 raw SQL。
        
    - 或者，确保所有写操作（INSERT/UPDATE）都进入同一个**单线程写入队列**，而读操作可以并发。
        
    - **范围**: 重构 `capsule_db.py`，实现一个线程安全的 Context Manager (`with db_connection(): ...`)。
        

#### 2. 路径管理的“单一真实源”

- **现状**: `capsule_api.py`、`utils.py`、`settings.json` 和 Rust 端 `paths.rs` 都有路径处理逻辑。`PREVIEW_404_FIX` 暴露了路径拼接的脆弱性。
    
- **修改建议**:
    
    - **Rust 掌权**: 让 Rust 端 (`paths.rs`) 作为路径的绝对权威。应用启动时，Rust 将路径通过环境变量或命令行参数传给 Python。Python **不再**自己猜测路径，只读取配置。
        
    - **范围**: 清理 `capsule_api.py` 开头的路径猜测逻辑，统一使用 `utils.get_app_paths()`。
        

#### 3. API 单体拆分 (Blueprints)

- **现状**: `capsule_api.py` 正在变成一个“上帝文件”，包含了 Auth、Sync、Download、Search、Export 所有逻辑，已经接近或超过 1000 行。
    
- **修改建议**:
    
    - 使用 Flask **Blueprints** 进行模块拆分。
        
    - `routes/auth.py`: 登录注册
        
    - `routes/library.py`: 胶囊增删改查
        
    - `routes/sync.py`: 同步与下载
        
    - `routes/export.py`: REAPER 交互
        
    - **范围**: 将 `capsule_api.py` 拆分为 `app.py` (入口) + `routes/` 目录。
        

---

### 🟡 优先级 2: 安全与权限 (强烈建议)

#### 4. 本地多用户隔离

- **现状**: 虽然云端有 RLS，但本地 SQLite 是单文件的。如果用户 A 和 用户 B 都在这台电脑用这个 App，他们的胶囊元数据其实都在 `capsules.db` 里。
    
- **修改建议**:
    
    - 在本地数据库查询时，**强制**加上 `WHERE user_id = current_user_id` 的过滤（除了“全球库”模式）。
        
    - 或者，更彻底一点：为每个用户创建独立的 SQLite 文件 `capsules_{user_id}.db`。
        
    - **范围**: 修改 `capsule_db.py` 的初始化逻辑。
        

#### 5. Supabase RLS 策略强化

- **现状**: 我们在 SQL 脚本中禁用了部分 RLS 或者写得比较宽泛。
    
- **修改建议**:
    
    - 严格审查 RLS 策略。确保 `UPDATE` 和 `DELETE` 操作必须匹配 `auth.uid()`。
        
    - **范围**: 重新运行并测试 `security_audit.sql`。
        

---

### 🟢 优先级 3: 前端与体验 (优化建议)

#### 6. 前端状态管理的“Props Drilling”

- **现状**: `App.jsx` 承载了太多状态（胶囊列表、当前胶囊、用户信息、搜索词...），并通过 props 一层层传给 `CapsuleLibrary` -> `CapsuleCard`。
    
- **修改建议**:
    
    - 引入 **React Context** 或 **Zustand**。
        
    - 创建一个 `CapsuleContext` 管理胶囊数据，`AuthContext` 管理用户，`UIContext` 管理弹窗和 Toast。
        
    - **范围**: 重构 `App.jsx`，瘦身主组件。
        

#### 7. 虚拟滚动 (Virtual Scrolling)

- **现状**: 胶囊库目前是直接渲染所有卡片。如果未来有 5000 个胶囊，DOM 节点过多会卡顿。
    
- **修改建议**:
    
    - 在 `CapsuleLibrary` 中引入 `react-window` 或 `virtuoso`。只渲染屏幕可见区域的胶囊。
        
    - **范围**: 仅针对 `CapsuleLibrary.jsx` 的 Grid/List 视图部分。