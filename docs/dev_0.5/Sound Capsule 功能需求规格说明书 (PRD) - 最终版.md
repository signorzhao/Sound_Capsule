

版本： v2.0 (Final Architecture)

日期： 2026-01-13

状态： 待开发/集成 (To Be Developed)

目标受众： 核心开发团队 (Developer B)

---

## 1. 项目愿景

Sound Capsule 是一个连接 **REAPER DAW** 与 **云端协作** 的智能声音资产管理系统。它通过“胶囊”概念封装音频素材，利用 AI 语义导航代替传统文件夹管理，并支持团队间的声音资产无缝流转。

---

## 2. 核心用户体验流程 (Critical User Flow)

这是系统的**最高优先级**逻辑，所有技术实现必须严格遵循此流程：

### 2.1 阶段一：初始化与配置 (Init & Auth)

1. **启动检查：** 用户打开应用。
    
2. **身份验证：**
    
    - 如果本地无有效 Token，停留在 **注册/登录页面**。
        
    - 支持用户注册、登录（基于 Supabase Auth）。
        
3. **首次运行向导 (First Run Wizard)：**
    
    - 新用户或首次运行，强制要求配置：
        
        - **REAPER 安装路径** (用于调用 REAPER 进行无头导出)。
            
        - **用户数据存储路径** (本地胶囊库的根目录)。
            
4. **路径变更逻辑 (Critical)：**
    
    - 用户可以在设置中随时修改“用户数据存储路径”。
        
    - **触发行为：** 一旦路径改变，系统必须执行以下操作（这部分是为了更换路径后，在胶囊库还可以成功预览ogg和导入rpp，现在的方法是个笨办法，如果有更好的方法，请和我商量）：
        
        1. **清除** 旧路径下的本地数据库连接引用（或提示用户手动迁移，默认逻辑为清空应用内的本地索引）。
            
        2. **重启** 应用或重置应用状态。
            
        3. 重启后，自动触发“阶段二”的全面轻数据拉取，重新构建本地缓存。
            

### 2.2 阶段二：全量轻数据同步 (Light Data Sync)

1. **触发时机：** 登录成功后 / 路径重置重启后（如果用的是清除本地数据的笨办法的话）
    
2. **同步内容（轻数据）：**
    
    - **元数据 (Metadata)：** 胶囊名称、ID、语义坐标、**使用的插件列表 (Plugins)**、嵌入的关键词。
        
    - **预览音频 (Preview Audio)：** `.ogg` 格式文件（体积小）。
        
    - **工程文件 (Project File)：** `.rpp` 文件（体积小，不含音频源文件）。
        
3. **同步策略：**
    
    - 应用启动时自动拉取 Supabase 上所有用户的胶囊的“轻数据”。
        
    - **注意：** 此时**不下载**源音频文件 (`.wav`)，以节省带宽和空间。
        

### 2.3 阶段三：资产采集 (Ingestion - The "Home" View)

1. **默认落地页：** 同步完成后，自动跳转至 **“胶囊保存 (Save Capsule)”** 页面。
    
2. **界面元素：**
    
    - 显示当前的 **胶囊类型 (Capsule Type)**（如 Magic, Impact, Atmosphere）。
        
    - 大尺寸的“保存”按钮。
        
3. **交互逻辑：**
    
    - 用户在 REAPER 中选中 Item。
        
    - 点击应用内的“保存”按钮（或通过全局快捷键触发）。
        
    - **后台执行：** 通过 Python Sidecar 调用 REAPER API (Headless 模式)，自动渲染预览、保存 RPP、复制源文件，生成胶囊包。
        

### 2.4 阶段四：语义嵌入 (Semantic Embedding)

1. **自动跳转：** 胶囊生成完毕后，自动跳转至 **“语义棱镜 (Prism)”** 页面。
    
2. **功能：**
    
    - 展示新生成的胶囊。
        
    - 用户通过拖拽或点击，在四个语义维度（质感、情绪、材质等）中为胶囊打标签。
        
    - 系统根据标签自动计算该胶囊在二维空间中的坐标 ($X, Y$)。
        
3. **数据提交：** 确认标签后，将关键词嵌入元数据，并更新本地数据库。
    

### 2.5 阶段五：库管理与上云 (Library & Upload)

1. **自动跳转：** 语义嵌入完成后，跳转至 **“胶囊库 (Library)”** 页面。
    
2. **视图状态：**
    
    - 用户可以看到刚刚制作的“本地胶囊”以及云端已有的“云端胶囊”。
        
    - **本地胶囊**状态标记为 `Local` 或 `Unsynced`。
        
3. **上云操作：**
    
    - 在胶囊卡片或列表项上，提供 **“同步/云端”图标按钮**。
        
    - 点击按钮：将该胶囊的**完整数据**（包含轻数据 + 重资产 `.wav` 源文件）上传至 Supabase Storage。
        
    - 状态变更为 `Synced`。
        
    除了启动时的全量比对，系统在运行时也需要感知变化：

- **被动感知 (Polling/Subscription):**
    
    - 前端应使用 Supabase 的 `Realtime` 订阅功能（或者每隔 N 分钟的轻量级轮询），监听 `capsules` 表的 `updated_at` 字段变化。
        
    - 如果发现云端 `updated_at` > 本地 `updated_at`，**不自动覆盖**本地数据（防止用户正在浏览时数据突变），而是**触发 UI 提示**（即上述状态 B）。
        
- **手动拉取 (Manual Pull):**
    
    - 当用户点击“更新提示”的图标时，调用 `sync_service.pull_light_data(capsule_id)`。
        
    - **数据合并策略：** 由于轻数据包含标签和坐标，拉取后应立即刷新前端的“语义棱镜”视图，使胶囊移动到新的语义位置。
---

## 3. 详细功能模块需求

### 3.1 模块 A：系统配置与路径管理 (System Config)

- **技术栈：** Tauri (Rust) + React Context.
    
- **需求：**
    
    - 必须持久化存储用户的配置（`config.json`）。
        
    - **路径重置保护：** 修改存储路径是危险操作，需弹出模态框（Modal）警告用户“将清除本地缓存并重启”。
        
    - **重启机制：** 调用 Tauri API `process.relaunch()` 实现应用自动重启。
        

### 3.2 模块 B：数据同步引擎 (Sync Engine)

- **技术栈：** Python (Sidecar) + Supabase SDK.
    
- **轻量级同步 (Down-Sync)：**
    
    - `GET /api/sync/lightweight`: 仅下载 `metadata` 表 + `preview.ogg` + `file.rpp`。
        
    - 确保 Supabase Storage 的目录结构支持单独获取这些文件。
        
- **按需下载 (JIT - Just In Time)：**
    
    - 当用户点击“在 REAPER 中打开”一个云端胶囊时，检查本地 `WAV` 是否存在。
        
    - 若不存在，触发 `Downloader` 下载重资产文件夹，并显示下载进度条。
    - 这部分现在已经有一个比较好的逻辑判断规则，点击后会弹出2个选项，1是下载完整数据后打开工程，2是直接打开忽略音频文件丢失
        

### 3.3 模块 C：REAPER 自动化导出 (Automation)

- **技术栈：** Python `subprocess` + Lua Scripts.
    
- **需求：**
    
    - **插件扫描：** 在导出过程中，Lua 脚本必须解析 `.rpp` 文件，提取该 Item 使用的 VST/AU 插件名称，并写入 `metadata.json` 的 `plugins` 字段。
        
    - **无头模式：** 确保导出过程不弹出 REAPER 的原生对话框，所有参数（名称、路径）由 Python 传入。
        

### 3.4 模块 D：语义棱镜系统 (Prisms)

- **技术栈：** React Canvas/SVG + Python Embedding.
    
- **需求：**
    
    - 支持动态加载棱镜配置（不硬编码）。
        
    - **坐标计算：** 本地模型计算，现在已经有了比较好的内容，可以选择不同的模型
    - 棱镜编辑器只会有我个人使用，修改棱镜数据后我会同步到云端供用户做轻数据同步下载，同步功能已在现有代码中了
        

### 3.5 模块 E：用户界面 (UI/UX)

- **风格：** Deep Space Tech (深色、玻璃拟态、3D 胶囊)。
    
- **组件：**
    
    - **UserMenu：** 顶部常驻，显示当前用户，提供路径设置入口。
        
    - **Toast：** 关键操作（保存成功、上传开始、下载完成）必须有 Toast 通知。
        
    - **Loading State：** 在“全面拉取轻数据”期间，显示全屏 Loading 动画或进度条，阻止用户操作。
    
云图标不再仅仅是一个“上传”按钮，它是胶囊当前**同步状态（Sync Status）**的指示器和操作入口。它必须处理以下三种情况：

- 状态 A：本地更新 (Local Dirty)**
    
    - **场景：** 当前用户（作为拥有者）修改了本地胶囊的标签或元数据，尚未上传。
        
    - **图标表现：** 云图标带有一个**向上箭头** (☁️⬆️) 或显示为橙色。
        
    - **点击行为：** 执行 **PUSH** 操作（上传元数据到云端）。
        
- **状态 B：云端更新 (Cloud Has Update)**
    
    - **场景：** 另一位用户（拥有者）在云端更新了该胶囊的标签，当前用户的本地数据已过时。
        
    - **图标表现：** 云图标带有一个**红色红点**或**向下箭头** (☁️⬇️/🔴)。
        
    - **点击行为：** 执行 **PULL** 操作（仅下载最新的 metadata.json, .rpp, preview.ogg，**不**重新下载重资产 WAV）。
        
- **状态 C：已同步 (Synced)**
    
    - **场景：** 本地与云端一致。
        
    - **图标表现：** 实心或勾选的云图标 (☁️✔)，颜色为灰色或主色调。
        
    - **点击行为：** 显示“已是最新”的 Toast 提示，或强制重新校验。

---

## 4. 数据结构定义

为了支持上述流程，数据被严格划分为两类：

### 4.1 轻数据 (Light Data) - _登录即同步_

- **存储位置：** Supabase Database (Table: `capsules`) + Storage (Bucket: `/previews`, `/projects`).
    
- **包含内容：**
    
    - `id` (UUID)
        
    - `name` (String)
        
    - `tags` (JSON Array)
        
    - `plugins` (JSON Array) - **新增**
        
    - `coordinates` (JSON Object: x, y per prism)
        
    - `preview_url` (指向 `.ogg`)
        
    - `project_file_url` (指向 `.rpp`)
        

### 4.2 重数据 (Heavy Data) - _按需下载 / 手动上传_

- **存储位置：** Supabase Storage (Bucket: `/assets`).
    
- **包含内容：**
    
    - 包含源音频文件 (`.wav` / `.aif`) 的完整文件夹。
        
    - 只有在用户点击“上传到云端”时上传。
        
    - 只有在用户点击“打开工程”且本地缺失时下载。

## 4.3  云端同步与权限控制 (Cloud & Sync - Phase B/C)

    **目标：** 实现多设备数据一致性，并构建基于“公共库、私有权”的协作模式。

- **功能点：**
    
    - **用户鉴权 (Phase A)：** 完整的 JWT 注册/登录流程。
        
    - **权限模型 (Permissions) [重点更新]:**
        
        - **全员可见：** 所有用户均可拉取并下载平台上的所有胶囊。
            
        - **所有权保护：** 只有胶囊的创建者（`user_id` 匹配）才有权限执行 **UPDATE**（修改标签、元数据）和 **DELETE**（删除胶囊）操作。
            
        - **他人资产处理：** 当用户浏览他人胶囊时，界面需隐藏“删除”入口，修改操作自动转为“另存为副本”或禁止修改。
            
    - **JIT (Just-In-Time) 决策流：**
        
        - **轻量级同步：** 默认仅同步元数据和预览音频。
            
        - **按需下载：** 点击“Open in REAPER”时，若本地缺失源文件，自动触发下载。
            
    - **数据一致性：**
        
        - Prism 版本号机制，解决配置冲突。
            
        - Supabase 实时同步状态反馈。
		

---

## 5. 开发者 B 执行清单 (Action Items)

1. **实现路径变更逻辑：** 在前端设置页实现“修改路径 -> 清空本地 DB -> Relaunch”的逻辑链。
    
2. **优化同步脚本：** 修改 `sync_service.py`，确保登录后的同步不仅拉取元数据，还自动下载对应的 OGG 和 RPP 文件到本地新路径。
    
3. **更新导出脚本：** 修改 Lua/Python 导出逻辑，增加对 REAPER FX Chain 的解析，提取插件名称。
    
4. **路由控制：** 调整 `App.jsx` 的路由守卫，确保：
    
    - `Login` -> `Sync (Loading)` -> `SaveHome`。
        
    - `Save` -> `Prism` -> `Library`。
        
5. **UI 调整：** 在胶囊库卡片上添加明确的“云端上传”图标按钮，并绑定上传 API。