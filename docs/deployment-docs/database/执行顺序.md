# SQL 执行顺序（按编号 001～007）

本目录下 **001～007** 为同一套迁移，按数字顺序在 Supabase **SQL Editor** 中执行即可。Storage bucket 在 Studio 中创建。

---

## 文件列表（按执行顺序）

| 顺序 | 文件名 | 说明 |
|------|--------|------|
| 1 | **001_supabase_schema.sql** | 胶囊表 + sync_log + RLS |
| 2 | **002_cloud_prisms_schema_fixed.sql** | 创建 cloud_prisms 表 |
| 3 | **003_cloud_prisms_add_is_active_field_data.sql** | 为 cloud_prisms 增加 is_active、field_data |
| 4 | **004_add_global_read_policies.sql** | （可选）多用户可读；**仅含 Storage SELECT，不含 INSERT** |
| 5 | **005_cloud_capsule_tags_add_keyword_columns.sql** | **必做**。关键词列，否则关键词同步失败 |
| 6 | **006_cloud_capsule_tags_drop_unique_per_lens.sql** | **必做**。删除唯一约束，否则多关键词 409 |
| 7 | **007_storage_capsule_files_allow_authenticated_upload.sql** | **必做（自建）**。为 capsule-files 添加上传策略；否则上传 403 |

---

## 执行方式

1. 打开 Supabase Studio → **SQL Editor**
2. 按 **001 → 002 → … → 007** 顺序，逐个打开本目录下对应 `.sql` 文件，复制内容到 SQL Editor 执行
3. 若已有部分表/策略，可只执行缺失的编号（如仅补执行 **007** 解决上传 403）

---

## Storage：创建 bucket

- 在 Studio → **Storage** → **New bucket**：名称 **`capsule-files`**，**不勾选** Public（私有）
- 创建后**必须**执行 **007**（或手动为 `capsule-files` 添加 INSERT 策略），否则上传会 403

---

## 其他

- **verify_schema.sql**：验证用，非迁移顺序内
- 执行 004 时若报错 `relation "storage.policies" does not exist`，可忽略
