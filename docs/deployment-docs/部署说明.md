# Supabase 自建部署说明（Sound Capsule）

在 Linux 主机上按顺序操作，完成一项勾选一项（把 `- [ ]` 改成 `- [x]`）。

---

## 一、安装 Docker（若未安装）

- [x] 执行：`sudo apt-get update`
- [x] 执行：`sudo apt-get install -y docker.io`
- [x] 执行：`sudo usermod -aG docker $USER`
- [x] 注销后重新登录，或执行：`newgrp docker`

---

## 二、部署 Supabase

- [x] 执行：`cd /home/sbadmin`
- [x] 执行：`chmod +x deploy-supabase.sh`
- [x] 执行：`./deploy-supabase.sh`（等待克隆、生成密钥、拉镜像、启动完成）
- [x] 若 `generate-keys.sh` 报错：手动编辑 `supabase-project/.env`，设置 `POSTGRES_PASSWORD`、`JWT_SECRET` 等后重试

---

## 三、按顺序执行 SQL（建表，不迁移业务数据）

在浏览器打开 **Supabase Studio**：`http://<服务器IP>:8000`（登录：用户名 `supabase`，密码见 `.env` 中 `DASHBOARD_PASSWORD`）→ **SQL Editor**，按顺序执行（详见 `database/执行顺序.md`）：

- [ ] **1** 执行：`database/001_supabase_schema.sql`
- [ ] **2** 执行：`database/002_cloud_prisms_schema_fixed.sql`
- [ ] **3** 执行：`database/003_cloud_prisms_add_is_active_field_data.sql`
- [ ] **4（可选）** 执行：`database/004_add_global_read_policies.sql`
- [ ] **5** 执行：`database/005_cloud_capsule_tags_add_keyword_columns.sql`（必做）
- [ ] **6** 执行：`database/006_cloud_capsule_tags_drop_unique_per_lens.sql`（必做）
- [ ] **7** 执行：`database/007_storage_capsule_files_allow_authenticated_upload.sql`（**自建必做**，否则上传 403）

---

## 四、创建 Storage 私有 bucket 与上传策略

- [ ] 在 Studio 中打开 **Storage** → **New bucket**
- [ ] 名称填：**`capsule-files`**
- [ ] **不勾选** Public（保持私有）
- [ ] 已执行 **007**（或手动为 `capsule-files` 添加 INSERT 策略），否则上传会 403

或使用 SQL 创建 bucket（若自建实例开放了 `storage.buckets` 写入）：

```sql
INSERT INTO storage.buckets (id, name, public)
VALUES ('capsule-files', 'capsule-files', false)
ON CONFLICT (id) DO NOTHING;
```

（创建 bucket 后仍需执行 007 添加上传策略。）

---

## 五、本地 .env.supabase 连接配置

- [x] 在本机项目的 `.env.supabase`（或 `.env`）中填写 **SUPABASE_URL**：`http://<这台服务器IP或域名>:8000`
- [x] 填写 **SUPABASE_SERVICE_ROLE_KEY**：在服务器上执行 `grep -E 'SERVICE_ROLE|JWT_SERVICE' /home/sbadmin/supabase-project/.env`，取输出的 JWT 长串
- [x] 确认未把 Service Role Key 写进前端或公开仓库

---

## 文件位置速查

- 部署脚本：`/home/sbadmin/deploy-supabase.sh`
- 执行顺序说明：`/home/sbadmin/database/执行顺序.md`
- 第 1 步完整 schema（备用）：`/home/sbadmin/supabase-schema.sql`
- 项目 SQL 目录：`/home/sbadmin/database/`
