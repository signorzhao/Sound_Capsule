# Phase B ç«¯åˆ°ç«¯æµ‹è¯•è®¡åˆ’

**æ—¥æœŸ**: 2026-01-11
**ç›®çš„**: éªŒè¯ Phase B æ‰€æœ‰åŠŸèƒ½åœ¨å®æˆ˜ç¯å¢ƒä¸­çš„å¯ç”¨æ€§
**é¢„è®¡è€—æ—¶**: 1-2 å°æ—¶

---

## ğŸ“‹ æµ‹è¯•èŒƒå›´

### æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•
1. âœ… è½»é‡çº§åŒæ­¥æœåŠ¡ï¼ˆ+ Supabase é›†æˆï¼‰
2. âœ… æŒ‰éœ€ä¸‹è½½æµç¨‹
3. âœ… æ™ºèƒ½ç¼“å­˜æ¸…ç†
4. âœ… å‰ç«¯ UI é›†æˆ
5. âœ… å¹¶å‘ä¸‹è½½æ€§èƒ½

### æµ‹è¯•ç¯å¢ƒè¦æ±‚
- âœ… Supabase è¿æ¥å¯ç”¨
- âœ… æœ¬åœ°æ•°æ®åº“å·²åˆå§‹åŒ–
- âœ… åç«¯ API å¯å¯åŠ¨
- âœ… å‰ç«¯ Tauri åº”ç”¨å¯è¿è¡Œ

---

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯• 1: åç«¯ API å¯åŠ¨å’ŒåŸºç¡€åŠŸèƒ½

**ç›®çš„**: éªŒè¯ API æœåŠ¡å™¨å¯ä»¥æ­£å¸¸å¯åŠ¨å¹¶å“åº”è¯·æ±‚

**æ­¥éª¤**:
```bash
# 1. è¿›å…¥ data-pipeline ç›®å½•
cd data-pipeline

# 2. å¯åŠ¨ API æœåŠ¡å™¨
python capsule_api.py

# 3. æ£€æŸ¥æ—¥å¿—è¾“å‡ºï¼Œç¡®è®¤å¯åŠ¨æˆåŠŸ
# 4. æµ‹è¯•åŸºç¡€ç«¯ç‚¹
curl http://localhost:5002/api/health
```

**é¢„æœŸç»“æœ**:
- âœ… API æœåŠ¡å™¨åœ¨ 5002 ç«¯å£å¯åŠ¨
- âœ… æ— æ•°æ®åº“è¿æ¥é”™è¯¯
- âœ… å¥åº·æ£€æŸ¥ç«¯ç‚¹è¿”å› 200

**å¸¸è§é—®é¢˜**:
- âŒ ç«¯å£è¢«å ç”¨ â†’ ä¿®æ”¹ç«¯å£æˆ–å…³é—­å ç”¨è¿›ç¨‹
- âŒ æ•°æ®åº“æ–‡ä»¶ä¸å­˜åœ¨ â†’ è¿è¡Œåˆå§‹åŒ–è„šæœ¬
- âŒ Supabase é…ç½®ç¼ºå¤± â†’ æ£€æŸ¥ .env æ–‡ä»¶

---

### æµ‹è¯• 2: è½»é‡çº§åŒæ­¥æœåŠ¡

**ç›®çš„**: éªŒè¯å…ƒæ•°æ®åŒæ­¥ä¸ Supabase é›†æˆ

**æ­¥éª¤**:
```bash
# 1. ç¡®ä¿å·²ç™»å½•ï¼ˆè·å– tokenï¼‰
TOKEN=$(cat .test_token)  # å‡è®¾å·²ä¿å­˜ token

# 2. è§¦å‘è½»é‡çº§åŒæ­¥
curl -X POST http://localhost:5002/api/sync/lightweight \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"include_previews": true}'

# 3. æ£€æŸ¥æ•°æ®åº“
sqlite3 database/capsules.db "SELECT id, name, cloud_status, asset_status FROM capsules LIMIT 5;"
```

**é¢„æœŸç»“æœ**:
- âœ… è¿”å›æˆåŠŸå“åº”
- âœ… `synced_count` > 0ï¼ˆå¦‚æœæœ‰äº‘ç«¯æ•°æ®ï¼‰
- âœ… æœ¬åœ°æ•°æ®åº“ `cloud_status` æ›´æ–°ä¸º 'synced'
- âœ… `asset_status` ä¿æŒä¸å˜ï¼ˆä¸ä¸‹è½½ WAVï¼‰

**éªŒè¯æ£€æŸ¥ç‚¹**:
```python
# æ£€æŸ¥åŒæ­¥ç»“æœ
{
    "success": true,
    "data": {
        "synced_count": 5,
        "preview_downloaded": 0,  # å¯èƒ½æœªå®ç°
        "duration_seconds": 2.5,
        "errors": []
    }
}
```

**å¸¸è§é—®é¢˜**:
- âŒ Supabase è®¤è¯å¤±è´¥ â†’ æ£€æŸ¥ SUPABASE_URL å’Œ SUPABASE_KEY
- âŒ äº‘ç«¯è¡¨ä¸å­˜åœ¨ â†’ è¿è¡Œ `setup_supabase.py`
- âŒ å­—æ®µä¸åŒ¹é… â†’ æ£€æŸ¥äº‘ç«¯è¡¨ç»“æ„

---

### æµ‹è¯• 3: æŒ‰éœ€ä¸‹è½½åŠŸèƒ½

**ç›®çš„**: éªŒè¯ WAV æ–‡ä»¶æŒ‰éœ€ä¸‹è½½æµç¨‹

**å‰ç½®æ¡ä»¶**: éœ€è¦ä¸€ä¸ª `asset_status = 'cloud_only'` çš„èƒ¶å›Š

**æ­¥éª¤**:
```bash
# 1. è·å–äº‘ç«¯èƒ¶å›Š ID
CAPSULE_ID=1  # æ›¿æ¢ä¸ºå®é™… ID

# 2. æŸ¥çœ‹å½“å‰çŠ¶æ€
curl http://localhost:5002/api/capsules/$CAPSULE_ID \
  -H "Authorization: Bearer $TOKEN"

# 3. è§¦å‘ WAV ä¸‹è½½
curl -X POST http://localhost:5002/api/capsules/$CAPSULE_ID/download-wav \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"force": false, "priority": 5}'

# 4. æŸ¥è¯¢ä¸‹è½½è¿›åº¦
curl http://localhost:5002/api/capsules/$CAPSULE_ID/download-status \
  -H "Authorization: Bearer $TOKEN"
```

**é¢„æœŸç»“æœ**:
- âœ… åˆ›å»ºä¸‹è½½ä»»åŠ¡ï¼ˆtask_idï¼‰
- âœ… `asset_status` æ›´æ–°ä¸º 'downloading'
- âœ… è¿›åº¦æŸ¥è¯¢è¿”å›å®æ—¶è¿›åº¦ï¼ˆ0-100%ï¼‰
- âœ… ä¸‹è½½å®Œæˆå `asset_status` = 'full'

**éªŒè¯æ£€æŸ¥ç‚¹**:
```python
# åˆå§‹å“åº”
{
    "success": true,
    "data": {
        "task_id": 123,
        "status": "pending",
        "progress": 0
    }
}

# è¿›åº¦å“åº”
{
    "success": true,
    "data": {
        "status": "downloading",
        "progress": 45,
        "downloaded_bytes": 5242880,
        "speed": "2.5 MB/s",
        "eta": "23s"
    }
}
```

**å¸¸è§é—®é¢˜**:
- âŒ Supabase Storage URL æ— æ•ˆ â†’ æ£€æŸ¥äº‘ç«¯å­˜å‚¨é…ç½®
- âŒ æœ¬åœ°ç›®å½•æ— å†™æƒé™ â†’ æ£€æŸ¥ export_dir æƒé™
- âŒ ä¸‹è½½é˜Ÿåˆ—æœªå¯åŠ¨ â†’ æ£€æŸ¥ DownloadQueue åˆå§‹åŒ–

---

### æµ‹è¯• 4: æ™ºèƒ½ç¼“å­˜æ¸…ç†

**ç›®çš„**: éªŒè¯æ™ºèƒ½ç¼“å­˜ç­–ç•¥

**å‰ç½®æ¡ä»¶**: éœ€è¦æœ‰ä¸€äº›ç¼“å­˜æ–‡ä»¶

**æ­¥éª¤**:
```bash
# 1. æŸ¥çœ‹å½“å‰ç¼“å­˜çŠ¶æ€
curl http://localhost:5002/api/cache/stats \
  -H "Authorization: Bearer $TOKEN"

# 2. è§¦å‘æ™ºèƒ½æ¸…ç†
curl -X POST http://localhost:5002/api/cache/smart-purge \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "target_usage_percent": 80.0,
    "keep_frequent": true,
    "min_access_count": 3
  }'

# 3. å†æ¬¡æŸ¥çœ‹ç¼“å­˜çŠ¶æ€
curl http://localhost:5002/api/cache/stats \
  -H "Authorization: Bearer $TOKEN"
```

**é¢„æœŸç»“æœ**:
- âœ… æ¸…ç†æˆåŠŸï¼ˆå³ä½¿æ²¡æœ‰æ–‡ä»¶å¯æ¸…ç†ï¼‰
- âœ… è¿”å›åˆ é™¤æ–‡ä»¶æ•°å’Œé‡Šæ”¾ç©ºé—´
- âœ… å›ºå®šç¼“å­˜ï¼ˆis_pinned=1ï¼‰ä¸è¢«åˆ é™¤

**éªŒè¯æ£€æŸ¥ç‚¹**:
```python
{
    "success": true,
    "data": {
        "files_deleted": 2,
        "space_freed": 52428800,
        "files_skipped": 1,
        "errors": []
    }
}
```

**å¸¸è§é—®é¢˜**:
- âŒ æ•°æ®åº“ç´¢å¼•æœªåˆ›å»º â†’ è¿è¡Œ `performance_indexes.sql`
- âŒ ç¼“å­˜ç›®å½•æ— æƒé™ â†’ æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿæƒé™

---

### æµ‹è¯• 5: å‰ç«¯ UI é›†æˆ

**ç›®çš„**: éªŒè¯å‰ç«¯ä¸åç«¯ API çš„é›†æˆ

**æ­¥éª¤**:
```bash
# 1. å¯åŠ¨ Tauri åº”ç”¨
cd webapp
npm run tauri dev

# 2. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·
# 3. æµ‹è¯•ä»¥ä¸‹åŠŸèƒ½ï¼š
```

**UI æµ‹è¯•æ£€æŸ¥ç‚¹**:
1. **èƒ¶å›Šåº“é¡µé¢**
   - âœ… äº‘ç«¯èƒ¶å›Šæ˜¾ç¤º â˜ï¸ å›¾æ ‡
   - âœ… æœ¬åœ°èƒ¶å›Šæ˜¾ç¤º âœ“ å›¾æ ‡
   - âœ… ä¸‹è½½ä¸­æ˜¾ç¤ºè¿›åº¦æ¡

2. **ç‚¹å‡»"å¯¼å…¥èƒ¶å›Š"**
   - âœ… å¦‚æœæ˜¯äº‘ç«¯èƒ¶å›Šï¼Œå¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†
   - âœ… ç¡®è®¤åæ˜¾ç¤ºä¸‹è½½è¿›åº¦å¯¹è¯æ¡†
   - âœ… è¿›åº¦å®æ—¶æ›´æ–°
   - âœ… ä¸‹è½½å®Œæˆåè‡ªåŠ¨æ‰“å¼€ REAPER

3. **ç¼“å­˜ç®¡ç†ç•Œé¢**
   - âœ… æ˜¾ç¤ºç¼“å­˜ç»Ÿè®¡ï¼ˆæ€»å¤§å°ã€ä½¿ç”¨ç‡ï¼‰
   - âœ… ç‚¹å‡»"æ¸…ç†ç¼“å­˜"æŒ‰é’®å·¥ä½œ
   - âœ… æ¸…ç†å®Œæˆååˆ·æ–°ç»Ÿè®¡

**å¸¸è§é—®é¢˜**:
- âŒ CORS é”™è¯¯ â†’ æ£€æŸ¥ API CORS é…ç½®
- âŒ è®¤è¯å¤±è´¥ â†’ æ£€æŸ¥å‰ç«¯ token å­˜å‚¨
- âŒ ç«¯å£ä¸åŒ¹é… â†’ æ£€æŸ¥å‰ç«¯ API åœ°å€é…ç½®

---

### æµ‹è¯• 6: å¹¶å‘ä¸‹è½½å‹åŠ›æµ‹è¯•

**ç›®çš„**: éªŒè¯ 3 ä¸ªå¹¶å‘ä¸‹è½½ä»»åŠ¡çš„ç¨³å®šæ€§

**æ­¥éª¤**:
```bash
# 1. åˆ›å»ºå¤šä¸ªä¸‹è½½ä»»åŠ¡
for i in {1..3}; do
  CAPSULE_ID=$i
  curl -X POST http://localhost:5002/api/capsules/$CAPSULE_ID/download-wav \
    -H "Authorization: Bearer $TOKEN" \
    -H "Content-Type: application/json" \
    -d '{"priority": 5}'
done

# 2. ç›‘æ§ä¸‹è½½é˜Ÿåˆ—çŠ¶æ€
watch -n 1 'curl -s http://localhost:5002/api/download-queue/status \
  -H "Authorization: Bearer $TOKEN" | jq'
```

**é¢„æœŸç»“æœ**:
- âœ… 3 ä¸ªä»»åŠ¡åŒæ—¶ä¸‹è½½
- âœ… æ—  SQLite å†™é”å†²çª
- âœ… å†…å­˜å ç”¨ < 500MB
- âœ… CPU ä½¿ç”¨ç‡ < 100%

**éªŒè¯æ£€æŸ¥ç‚¹**:
```python
{
    "success": true,
    "data": {
        "pending_count": 0,
        "downloading_count": 3,
        "completed_count": 0,
        "failed_count": 0
    }
}
```

**å¸¸è§é—®é¢˜**:
- âŒ æ•°æ®åº“é”å®š â†’ æ£€æŸ¥æ˜¯å¦æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„æ•°æ®åº“è¿æ¥
- âŒ å†…å­˜æ³„æ¼ â†’ æ£€æŸ¥æ–‡ä»¶å¥æŸ„æ˜¯å¦å…³é—­

---

## ğŸ”§ æµ‹è¯•å‡†å¤‡æ¸…å•

### ç¯å¢ƒæ£€æŸ¥
- [ ] Python 3.8+ å·²å®‰è£…
- [ ] Node.js 16+ å·²å®‰è£…
- [ ] Supabase é¡¹ç›®å·²åˆ›å»º
- [ ] `.env.supabase` æ–‡ä»¶å·²é…ç½®
- [ ] æ•°æ®åº“å·²åˆå§‹åŒ–ï¼ˆ`database/capsules.db` å­˜åœ¨ï¼‰

### é…ç½®æ£€æŸ¥
- [ ] `SUPABASE_URL` å’Œ `SUPABASE_KEY` å·²è®¾ç½®
- [ ] Supabase è¡¨ `cloud_capsules` å·²åˆ›å»º
- [ ] Supabase Storage bucket `capsules` å·²åˆ›å»º
- [ ] æ€§èƒ½ç´¢å¼•å·²æ‰§è¡Œï¼ˆ21 ä¸ªç´¢å¼•ï¼‰

### ä¾èµ–æ£€æŸ¥
```bash
# Python ä¾èµ–
pip install flask flask-cors requests supabase

# å‰ç«¯ä¾èµ–
cd webapp
npm install
```

---

## ğŸ“Š æµ‹è¯•ç»“æœè®°å½•è¡¨

| æµ‹è¯•é¡¹ | çŠ¶æ€ | è€—æ—¶ | é—®é¢˜è®°å½• | ä¸¥é‡ç¨‹åº¦ |
|-------|------|------|---------|---------|
| 1. API å¯åŠ¨ | â¬œ | - | - | - |
| 2. è½»é‡çº§åŒæ­¥ | â¬œ | - | - | - |
| 3. æŒ‰éœ€ä¸‹è½½ | â¬œ | - | - | - |
| 4. ç¼“å­˜æ¸…ç† | â¬œ | - | - | - |
| 5. å‰ç«¯é›†æˆ | â¬œ | - | - | - |
| 6. å¹¶å‘ä¸‹è½½ | â¬œ | - | - | - |

**çŠ¶æ€è¯´æ˜**:
- âœ… é€šè¿‡
- âš ï¸ éƒ¨åˆ†é€šè¿‡
- âŒ å¤±è´¥
- â¬œ æœªæµ‹è¯•

**ä¸¥é‡ç¨‹åº¦**:
- ğŸ”´ ä¸¥é‡ - é˜»å¡åŠŸèƒ½ä½¿ç”¨
- ğŸŸ¡ ä¸­ç­‰ - å½±å“ç”¨æˆ·ä½“éªŒ
- ğŸŸ¢ è½»å¾® - å¯æš‚ç¼“ä¿®å¤

---

## ğŸ› å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜ 1: Supabase è¿æ¥å¤±è´¥
**ç—‡çŠ¶**: `{"message": "Invalid API key"}`

**è§£å†³**:
```bash
# æ£€æŸ¥ç¯å¢ƒå˜é‡
cat .env.supabase | grep SUPABASE

# éªŒè¯ URL å¯è®¿é—®
curl $SUPABASE_URL

# é‡æ–°é…ç½® Supabase
python setup_supabase.py
```

### é—®é¢˜ 2: æ•°æ®åº“ç´¢å¼•æœªç”Ÿæ•ˆ
**ç—‡çŠ¶**: æŸ¥è¯¢ä»ç„¶å¾ˆæ…¢

**è§£å†³**:
```bash
# æ£€æŸ¥ç´¢å¼•æ˜¯å¦å­˜åœ¨
sqlite3 database/capsules.db "
SELECT name FROM sqlite_master
WHERE type='index' AND name LIKE 'idx_%';
"

# é‡æ–°åˆ›å»ºç´¢å¼•
sqlite3 database/capsules.db < database/performance_indexes.sql
```

### é—®é¢˜ 3: ä¸‹è½½ä»»åŠ¡å¡ä½
**ç—‡çŠ¶**: è¿›åº¦ä¸€ç›´ä¸å˜

**è§£å†³**:
```bash
# æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
sqlite3 database/capsules.db "
SELECT id, status, progress, error_message
FROM download_tasks
ORDER BY created_at DESC
LIMIT 5;
"

# é‡å¯ API æœåŠ¡å™¨
pkill -f capsule_api.py
python capsule_api.py
```

---

## ğŸ“ æµ‹è¯•æ‰§è¡Œå‘½ä»¤

### å¿«é€Ÿæµ‹è¯•ï¼ˆ5 åˆ†é’Ÿï¼‰
```bash
# åªæµ‹è¯•æ ¸å¿ƒåŠŸèƒ½
cd data-pipeline
python capsule_api.py &

sleep 3

# æµ‹è¯•å¥åº·æ£€æŸ¥
curl http://localhost:5002/api/health

# æµ‹è¯•ç¼“å­˜ç»Ÿè®¡
curl http://localhost:5002/api/cache/stats

# åœæ­¢æœåŠ¡å™¨
pkill -f capsule_api.py
```

### å®Œæ•´æµ‹è¯•ï¼ˆ30 åˆ†é’Ÿï¼‰
```bash
# æŒ‰ç…§æµ‹è¯•ç”¨ä¾‹é¡ºåºæ‰§è¡Œ
# è§ä¸Šæ–¹æµ‹è¯•ç”¨ä¾‹éƒ¨åˆ†
```

---

## âœ… æµ‹è¯•å®Œæˆæ ‡å‡†

### å¿…é¡»é€šè¿‡ï¼ˆä¸¥é‡çº§åˆ« ğŸ”´ï¼‰
- âœ… API æœåŠ¡å™¨å¯ä»¥å¯åŠ¨
- âœ… è½»é‡çº§åŒæ­¥å¯ä»¥å®Œæˆï¼ˆæ— è‡´å‘½é”™è¯¯ï¼‰
- âœ… æŒ‰éœ€ä¸‹è½½å¯ä»¥åˆ›å»ºä»»åŠ¡

### åº”è¯¥é€šè¿‡ï¼ˆä¸¥é‡çº§åˆ« ğŸŸ¡ï¼‰
- âœ… æ™ºèƒ½ç¼“å­˜æ¸…ç†å·¥ä½œ
- âœ… å‰ç«¯å¯ä»¥è°ƒç”¨ API
- âœ… å¹¶å‘ä¸‹è½½æ— å´©æºƒ

### å¯é€‰é€šè¿‡ï¼ˆä¸¥é‡çº§åˆ« ğŸŸ¢ï¼‰
- âœ… é¢„è§ˆéŸ³é¢‘è‡ªåŠ¨ä¸‹è½½
- âœ… æ–­ç‚¹ç»­ä¼ åœ¨çœŸå®ç½‘ç»œç¯å¢ƒéªŒè¯

---

## ğŸ“‹ æµ‹è¯•æ€»ç»“æ¨¡æ¿

```markdown
## Phase B ç«¯åˆ°ç«¯æµ‹è¯•æ€»ç»“

**æµ‹è¯•æ—¶é—´**: YYYY-MM-DD HH:MM
**æµ‹è¯•äººå‘˜**: [å§“å]
**æµ‹è¯•ç¯å¢ƒ**: [å¼€å‘/ç”Ÿäº§]

### æµ‹è¯•ç»“æœ
- é€šè¿‡: X/6
- å¤±è´¥: Y/6
- è·³è¿‡: Z/6

### å‘ç°çš„é—®é¢˜
1. [é—®é¢˜æè¿°]
   - ä¸¥é‡ç¨‹åº¦: ğŸ”´/ğŸŸ¡/ğŸŸ¢
   - å¤ç°æ­¥éª¤: ...
   - ä¸´æ—¶è§£å†³æ–¹æ¡ˆ: ...

### ä¸‹ä¸€æ­¥è¡ŒåŠ¨
- [ ] ä¿®å¤ä¸¥é‡é—®é¢˜
- [ ] é‡æ–°æµ‹è¯•å¤±è´¥ç”¨ä¾‹
- [ ] è¿›å…¥ Phase C

### é™„å½•
- æµ‹è¯•æ—¥å¿—: [é“¾æ¥]
- é”™è¯¯æˆªå›¾: [é“¾æ¥]
```

---

**å‡†å¤‡å¼€å§‹æµ‹è¯•ï¼Ÿ** è®©æˆ‘çŸ¥é“ï¼Œæˆ‘ä¼šå¸®ä½ æ‰§è¡Œç¬¬ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼
