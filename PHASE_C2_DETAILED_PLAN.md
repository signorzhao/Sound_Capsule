# Phase C2: äº‘ç«¯ Embedding API è¯¦ç»†è®¡åˆ’

**ç›®æ ‡**: å°†è¯­ä¹‰åæ ‡è®¡ç®—ä»å®¢æˆ·ç«¯è¿ç§»åˆ°äº‘ç«¯ï¼Œå‡å°‘å®¢æˆ·ç«¯è´Ÿæ‹…

**ç°çŠ¶é—®é¢˜**:
- ç”¨æˆ·éœ€è¦ä¸‹è½½å·¨å¤§çš„ PyTorch æ¨¡å‹ï¼ˆ~500MBï¼‰
- å®¢æˆ·ç«¯è®¡ç®—æ¶ˆè€—å¤§é‡ CPU/å†…å­˜
- é¦–æ¬¡åŠ è½½æ—¶é—´é•¿
- ç§»åŠ¨è®¾å¤‡æ€§èƒ½å—é™

**è§£å†³æ–¹æ¡ˆ**:
- äº‘ç«¯éƒ¨ç½² Embedding æ¨¡å‹
- æä¾› REST API æ¥å£
- å®¢æˆ·ç«¯åªéœ€å‘é€æ–‡æœ¬ï¼Œè¿”å›åæ ‡

---

## ğŸ“‹ æŠ€æœ¯æ ˆé€‰æ‹©

### åç«¯æ¡†æ¶
**FastAPI** (æ¨è)
- é«˜æ€§èƒ½å¼‚æ­¥æ¡†æ¶
- è‡ªåŠ¨ API æ–‡æ¡£ï¼ˆSwaggerï¼‰
- ç±»å‹æç¤ºæ”¯æŒ
- æ˜“äºéƒ¨ç½²

### æ¨¡å‹æœåŠ¡
**Sentence Transformers**
- é¢„è®­ç»ƒçš„å¤šè¯­è¨€æ¨¡å‹
- æ”¯æŒ 100+ ç§è¯­è¨€
- ä¼˜ç§€çš„è¯­ä¹‰è¡¨ç¤ºèƒ½åŠ›

**æ¨èæ¨¡å‹**: `sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2`
- å¤§å°: ~470MB
- è¯­è¨€: å¤šè¯­è¨€ï¼ˆæ”¯æŒä¸­æ–‡ï¼‰
- æ€§èƒ½: ä¼˜ç§€çš„å¹³è¡¡

### ç¼“å­˜å±‚
**Redis** (æ¨è)
- å†…å­˜æ•°æ®åº“ï¼Œæå¿«å“åº”
- æ”¯æŒ TTLï¼ˆè‡ªåŠ¨è¿‡æœŸï¼‰
- å‡å°‘é‡å¤è®¡ç®—

**æ›¿ä»£æ–¹æ¡ˆ**: å¦‚æœä¸æƒ³éƒ¨ç½² Redisï¼Œå¯ä»¥ä½¿ç”¨ Python å­—å…¸ç¼“å­˜

### éƒ¨ç½²æ–¹æ¡ˆ
**Docker + Docker Compose**
- å®¹å™¨åŒ–éƒ¨ç½²
- æ˜“äºæ‰©å±•
- ç¯å¢ƒéš”ç¦»

---

## ğŸ¯ Phase C2 ä»»åŠ¡åˆ†è§£

### C2.1: æ ¸å¿ƒ Embedding æœåŠ¡ (2-3å°æ—¶)

**ä»»åŠ¡**:
1. åˆ›å»º FastAPI åº”ç”¨
2. åŠ è½½ Sentence Transformers æ¨¡å‹
3. å®ç° text â†’ embedding è½¬æ¢
4. å®ç° embedding â†’ 2D åæ ‡æ˜ å°„

**æ–‡ä»¶ç»“æ„**:
```
data-pipeline/
â”œâ”€â”€ embedding_service.py       # FastAPI æœåŠ¡ä¸»æ–‡ä»¶
â”œâ”€â”€ embedding_cache.py          # Redis ç¼“å­˜ç®¡ç†
â”œâ”€â”€ requirements-embedding.txt  # ä¾èµ–æ¸…å•
â””â”€â”€ docker-compose.yml          # Docker é…ç½®
```

**æ ¸å¿ƒ API ç«¯ç‚¹**:
```python
# 1. å¥åº·æ£€æŸ¥
GET /api/health

# 2. æ–‡æœ¬è½¬ Embedding
POST /api/embed
Request: {"text": "ç²—ç³™çš„å£°éŸ³"}
Response: {"embedding": [0.1, 0.2, ...]}

# 3. æ–‡æœ¬è½¬åæ ‡ï¼ˆä½¿ç”¨ prism é…ç½®ï¼‰
POST /api/embed/coordinate
Request: {
    "text": "ç²—ç³™çš„å£°éŸ³",
    "prism_id": "texture"
}
Response: {"x": 75.3, "y": 42.1}

# 4. æ‰¹é‡è½¬æ¢
POST /api/embed/batch
Request: {
    "texts": ["ç²—ç³™", "å…‰æ»‘", "æ˜äº®"],
    "prism_id": "texture"
}
Response: {
    "coordinates": [
        {"text": "ç²—ç³™", "x": 75.3, "y": 42.1},
        {"text": "å…‰æ»‘", "x": 25.1, "y": 55.2},
        {"text": "æ˜äº®", "x": 60.8, "y": 78.9}
    ]
}
```

### C2.2: Redis ç¼“å­˜é›†æˆ (1-2å°æ—¶)

**ä»»åŠ¡**:
1. è®¾è®¡ç¼“å­˜ key ç­–ç•¥
2. å®ç° Redis å®¢æˆ·ç«¯
3. æ·»åŠ ç¼“å­˜è¯»å†™é€»è¾‘
4. è®¾ç½® TTLï¼ˆ7 å¤©ï¼‰

**ç¼“å­˜ç­–ç•¥**:
```python
# Cache Key æ ¼å¼
embedding:{text_hash}          # å­˜å‚¨ embedding å‘é‡
coordinate:{prism_id}:{text_hash}  # å­˜å‚¨åæ ‡

# TTL
7 å¤©ï¼ˆè‡ªåŠ¨æ¸…ç†è¿‡æœŸæ•°æ®ï¼‰
```

### C2.3: åæ ‡æ˜ å°„ç®—æ³• (1å°æ—¶)

**ä»»åŠ¡**:
1. å®ç°é«˜ç»´å‘é‡ â†’ 2D åæ ‡æ˜ å°„
2. æ”¯æŒä¸åŒ prism çš„é”šç‚¹ç³»ç»Ÿ
3. å¤„ç†è¾¹ç•Œæƒ…å†µ

**ç®—æ³•**:
```python
def map_to_coordinate(embedding, prism_config):
    """
    å°† 384 ç»´ embedding æ˜ å°„åˆ° 2D åæ ‡

    æ­¥éª¤:
    1. åŠ è½½ prism çš„é”šç‚¹ embedding
    2. ä½¿ç”¨ PCA æˆ–ç›¸ä¼¼åº¦è®¡ç®—
    3. æ˜ å°„åˆ° 2D ç©ºé—´
    """
    # TODO: å®ç°
```

### C2.4: Docker éƒ¨ç½² (1å°æ—¶)

**ä»»åŠ¡**:
1. åˆ›å»º Dockerfile
2. é…ç½® docker-compose.yml
3. æ·»åŠ ç¯å¢ƒå˜é‡é…ç½®
4. æµ‹è¯•æœ¬åœ°éƒ¨ç½²

**Docker é…ç½®**:
```yaml
# docker-compose.yml
version: '3.8'
services:
  embedding-api:
    build: .
    ports:
      - "8000:8000"
    environment:
      - REDIS_URL=redis://redis:6379
      - MODEL_NAME=sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2
    depends_on:
      - redis

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
```

### C2.5: æµ‹è¯•å’Œæ–‡æ¡£ (1å°æ—¶)

**ä»»åŠ¡**:
1. å•å…ƒæµ‹è¯•
2. æ€§èƒ½æµ‹è¯•
3. API æ–‡æ¡£
4. éƒ¨ç½²æ–‡æ¡£

---

## ğŸ“Š æ€§èƒ½ç›®æ ‡

### å“åº”æ—¶é—´
```
æ— ç¼“å­˜: ~100-200msï¼ˆæ¨¡å‹æ¨ç†ï¼‰
æœ‰ç¼“å­˜: ~5-10msï¼ˆRedis æŸ¥è¯¢ï¼‰
```

### å¹¶å‘èƒ½åŠ›
```
å•å®ä¾‹: ~10-20 requests/s
å¯æ‰©å±•: é€šè¿‡ Docker æ°´å¹³æ‰©å±•
```

### èµ„æºæ¶ˆè€—
```
å†…å­˜: ~2GBï¼ˆæ¨¡å‹ + Redisï¼‰
CPU: 2 æ ¸
å­˜å‚¨: ~1GBï¼ˆæ¨¡å‹æ–‡ä»¶ï¼‰
```

---

## ğŸ”§ æŠ€æœ¯å†³ç­–é—®é¢˜

### Q1: æ˜¯å¦ä½¿ç”¨ Redisï¼Ÿ

**é€‰é¡¹ A: ä½¿ç”¨ Redis**ï¼ˆæ¨èï¼‰
- âœ… æŒä¹…åŒ–ç¼“å­˜
- âœ… æ”¯æŒå¤šå®ä¾‹å…±äº«
- âœ… è‡ªåŠ¨è¿‡æœŸ
- âŒ éœ€è¦é¢å¤–éƒ¨ç½²

**é€‰é¡¹ B: ä½¿ç”¨å†…å­˜ç¼“å­˜**
- âœ… ç®€å•ï¼Œæ— éœ€é¢å¤–æœåŠ¡
- âœ… å¼€å‘æµ‹è¯•æ–¹ä¾¿
- âŒ ä¸æ”¯æŒå¤šå®ä¾‹
- âŒ é‡å¯ä¸¢å¤±ç¼“å­˜

**å»ºè®®**: å¼€å‘é˜¶æ®µç”¨å†…å­˜ç¼“å­˜ï¼Œç”Ÿäº§ç¯å¢ƒç”¨ Redis

### Q2: æ¨¡å‹é€‰æ‹©ï¼Ÿ

**é€‰é¡¹ A: MiniLM-L12**ï¼ˆæ¨èï¼‰
- å¤§å°: ~470MB
- é€Ÿåº¦: å¿«
- å‡†ç¡®åº¦: ä¸­ç­‰

**é€‰é¡¹ B: larger model**
- å¤§å°: ~1GB+
- é€Ÿåº¦: æ…¢
- å‡†ç¡®åº¦: æ›´é«˜

**å»ºè®®**: å…ˆç”¨ MiniLMï¼Œå¦‚æœæ•ˆæœä¸å¥½å†å‡çº§

### Q3: éƒ¨ç½²æ–¹å¼ï¼Ÿ

**é€‰é¡¹ A: Docker æœ¬åœ°éƒ¨ç½²**ï¼ˆæ¨èï¼‰
- âœ… ç®€å•å¿«é€Ÿ
- âœ… æ˜“äºæµ‹è¯•
- âŒ éœ€è¦ç»´æŠ¤æœåŠ¡å™¨

**é€‰é¡¹ B: äº‘æœåŠ¡ï¼ˆAWS/GCP/Azureï¼‰**
- âœ… è‡ªåŠ¨æ‰©å±•
- âœ… é«˜å¯ç”¨
- âŒ æˆæœ¬è¾ƒé«˜

**å»ºè®®**: å…ˆç”¨ Docker æœ¬åœ°éƒ¨ç½²ï¼Œæˆç†Ÿåè€ƒè™‘äº‘æœåŠ¡

---

## ğŸ“ æ–‡ä»¶æ¸…å•

### éœ€è¦åˆ›å»ºçš„æ–‡ä»¶
1. `embedding_service.py` - FastAPI æœåŠ¡
2. `embedding_cache.py` - ç¼“å­˜ç®¡ç†
3. `requirements-embedding.txt` - Python ä¾èµ–
4. `Dockerfile` - Docker é…ç½®
5. `docker-compose.yml` - å®Œæ•´æœåŠ¡æ ˆ
6. `test_embedding_api.py` - æµ‹è¯•è„šæœ¬
7. `.env.embedding` - ç¯å¢ƒå˜é‡

### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶
1. `capsule_api.py` - æ·»åŠ ä»£ç†ç«¯ç‚¹ï¼ˆå¯é€‰ï¼‰

---

## ğŸ¯ æˆåŠŸæ ‡å‡†

- [ ] FastAPI æœåŠ¡æ­£å¸¸å¯åŠ¨
- [ ] æ¨¡å‹æˆåŠŸåŠ è½½
- [ ] å•ä¸ªæ–‡æœ¬è½¬æ¢ < 200ms
- [ ] ç¼“å­˜å‘½ä¸­ < 10ms
- [ ] æ‰¹é‡è½¬æ¢æ”¯æŒ
- [ ] Docker éƒ¨ç½²æˆåŠŸ
- [ ] API æ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆ
- [ ] æµ‹è¯•å…¨éƒ¨é€šè¿‡

---

## â±ï¸ é¢„è®¡æ—¶é—´

```
C2.1: æ ¸å¿ƒ Embedding æœåŠ¡  - 2-3 å°æ—¶
C2.2: Redis ç¼“å­˜é›†æˆ      - 1-2 å°æ—¶
C2.3: åæ ‡æ˜ å°„ç®—æ³•        - 1 å°æ—¶
C2.4: Docker éƒ¨ç½²         - 1 å°æ—¶
C2.5: æµ‹è¯•å’Œæ–‡æ¡£          - 1 å°æ—¶

æ€»è®¡: 6-8 å°æ—¶
```

---

**ä¸‹ä¸€æ­¥**: å¼€å§‹å®ç° C2.1 - æ ¸å¿ƒ Embedding æœåŠ¡

ä½ å‡†å¤‡å¥½äº†å—ï¼Ÿæˆ‘ä»¬å¼€å§‹ï¼ğŸš€
